var t={Renderer:class{constructor(t){this.debug=t.debug,this.reset(t.canvas),this.models={},this.renderers={}}reset(t){this.canvas=t,this.objs=0,this.current={},this.next={},this.textures={},this.gl=this.canvas.getContext("webgl2"),this.gl.blendFunc(770,771),this.gl.activeTexture(33984),this.program=this.gl.createProgram(),this.gl.shaderSource(this.t=this.gl.createShader(35633),"#version 300 es\nprecision highp float;\n#define GLSLIFY 1\nin vec4 pos,col,uv,normal;uniform mat4 pv,eye,m,im;uniform vec4 bb;out vec4 v_pos,v_col,v_uv,v_normal;void main(){gl_Position=pv*(v_pos=bb.z>0.? m[3]+eye*(pos*bb): m*pos);v_col=col;v_uv=uv;v_normal=transpose(inverse(m))*normal;}"),this.gl.compileShader(this.t),this.gl.attachShader(this.program,this.t),this.debug&&console.log("vertex shader:",this.gl.getShaderInfoLog(this.t)||"OK"),this.gl.shaderSource(this.t=this.gl.createShader(35632),"#version 300 es\nprecision highp float;\n#define GLSLIFY 1\nin vec4 v_pos,v_col,v_uv,v_normal;uniform vec3 light;uniform vec4 o;uniform sampler2D sampler;out vec4 c;void main(){c=mix(texture(sampler,v_uv.xy),v_col,o[3]);if(o[1]>0.){if(o[0]>0.){c=vec4(c.rgb*(max(dot(light,-normalize(vec3(v_normal.xyz))),0.0)+o[2]),c.a);}else{c=vec4(c.rgb*(max(dot(light,-normalize(cross(dFdx(v_pos.xyz),dFdy(v_pos.xyz)))),0.0)+o[2]),c.a);}}}"),this.gl.compileShader(this.t),this.gl.attachShader(this.program,this.t),this.debug&&console.log("fragment shader:",this.gl.getShaderInfoLog(this.t)||"OK"),this.gl.linkProgram(this.program),this.gl.useProgram(this.program),this.debug&&console.log("program:",this.gl.getProgramInfoLog(this.program)||"OK"),this.gl.clearColor(1,1,1,1),this.clearColor=t=>this.gl.clearColor(...this.col(t)),this.clearColor("ffff"),this.gl.enable(2929),this.light({y:-1}),this.camera({fov:30}),this.draw()}setState(t,e,s=[]){var i=Math.tan;this.state=t,this.state.n||="o"+this.objs++,this.state.size&&(this.state.w=this.state.h=this.state.d=this.state.size),this.state.t&&this.state.t.width&&!this.textures[this.state.t.id]&&(this.texture=this.gl.createTexture(),this.gl.pixelStorei(37441,!0),this.gl.bindTexture(3553,this.texture),this.gl.pixelStorei(37440,1),this.gl.texImage2D(3553,0,6408,6408,5121,this.state.t),this.gl.generateMipmap(3553),this.textures[this.state.t.id]=this.texture),this.state={type:e,...this.current[this.state.n]=this.next[this.state.n]||{w:1,h:1,d:1,x:0,y:0,z:0,rx:0,ry:0,rz:0,b:"888",mode:4,mix:0},...this.state,f:0},this.model&&(this.models[this.state.type]?.vertices&&!this.models?.[this.state.type].verticesBuffer&&(this.gl.bindBuffer(34962,this.models[this.state.type].verticesBuffer=this.gl.createBuffer()),this.gl.bufferData(34962,new Float32Array(this.models[this.state.type].vertices),35044)),this.models[this.state.type]?.uv&&!this.models[this.state.type].uvBuffer&&(this.gl.bindBuffer(34962,this.models[this.state.type].uvBuffer=this.gl.createBuffer()),this.gl.bufferData(34962,new Float32Array(this.models[this.state.type].uv),35044)),this.models[this.state.type]?.indices&&!this.models[this.state.type].indicesBuffer&&(this.gl.bindBuffer(34963,this.models[this.state.type].indicesBuffer=this.gl.createBuffer()),this.gl.bufferData(34963,new Uint16Array(this.models[t.type].indices),35044),!this.models[this.state.type].smoothNormals&&this.smooth&&this.smooth(this.state),this.models[this.state.type].smoothNormals&&(this.gl.bindBuffer(34962,this.models[this.state.type].smoothNormalsBuffer=this.gl.createBuffer()),this.gl.bufferData(34962,new Float32Array(this.models[this.state.type].smoothNormals.flat()),35044)))),this.state.t?this.state.t&&!this.state.mix&&(this.state.mix=0):this.state.mix=1,this.next[this.state.n]=this.state,this.state.fov&&(this.perspective=new DOMMatrix([1/i(.0175*this.state.fov)/(this.canvas.width/this.canvas.height),0,0,0,0,1/i(.0175*this.state.fov),0,0,0,0,1e3/-998,-1,0,0,1998/-998,0]))}draw(t=0,e,s,i,h=[]){for(i in this.lastFrame||=0,this.dt=t-this.lastFrame,this.lastFrame=t,this.gl.clear(16640),this.v=s,this.v=this.animation("camera"),this.gl.uniformMatrix4fv(this.gl.getUniformLocation(this.program,"eye"),!1,this.v.toFloat32Array()),this.v.invertSelf(),this.v.preMultiplySelf(this.perspective),this.gl.uniformMatrix4fv(this.gl.getUniformLocation(this.program,"pv"),!1,this.v.toFloat32Array()),this.gl.uniform3f(this.gl.getUniformLocation(this.program,"light"),this.lerp("light","x"),this.lerp("light","y"),this.lerp("light","z")),this.next)this.next[i].t||1!=this.col(this.next[i].b)[3]?this.transparent.push(this.next[i]):this.render(this.next[i],this.dt);for(i in h.sort(((t,e)=>this.dist(e)-this.dist(t))),this.gl.enable(3042),this.transparent)this.render(this.transparent[i],this.dt);this.gl.disable(3042),window.requestAnimationFrame((()=>this.draw()))}addModel(t,e,s){this.model[e]=s,this.setState(t,e)}render(t){this.object=t,this.object.t&&(this.gl.bindTexture(3553,this.textures[this.object.t.id]),this.gl.uniform1i(this.gl.getUniformLocation(this.program,"sampler"),0)),this.object.f<this.object.a&&(this.object.f+=this.dt),this.object.f>this.object.a&&(this.object.f=this.object.a),this.next[this.object.n].m=this.animation(this.object.n),this.next[this.object.g]&&this.next[this.object.n].m.preMultiplySelf(this.next[this.object.g].M||this.next[this.object.g].m),this.gl.uniformMatrix4fv(this.gl.getUniformLocation(this.program,"m"),!1,(this.next[this.object.n].M||this.next[this.object.n].m).toFloat32Array()),this.gl.uniformMatrix4fv(this.gl.getUniformLocation(this.program,"im"),!1,new DOMMatrix(this.next[this.object.n].M||this.next[this.object.n].m).invertSelf().toFloat32Array()),["camera","light","group"].includes(this.object.type)||(this.gl.bindBuffer(34962,this.models[this.object.type].verticesBuffer),this.gl.vertexAttribPointer(this.buffer=this.gl.getAttribLocation(this.program,"pos"),3,5126,!1,0,0),this.gl.enableVertexAttribArray(this.buffer),this.models[this.object.type].uvBuffer&&(this.gl.bindBuffer(34962,this.models[this.object.type].uvBuffer),this.gl.vertexAttribPointer(this.buffer=this.gl.getAttribLocation(this.program,"uv"),2,5126,!1,0,0),this.gl.enableVertexAttribArray(this.buffer)),this.object.s&&this.models[this.object.type].smoothNormalsBuffer&&(this.gl.bindBuffer(34962,this.models[this.object.type].smoothNormalsBuffer),this.gl.vertexAttribPointer(this.buffer=this.gl.getAttribLocation(this.program,"normal"),3,5126,!1,0,0),this.gl.enableVertexAttribArray(this.buffer)),this.gl.uniform4f(this.gl.getUniformLocation(this.program,"o"),this.object.s,(3<this.object.mode||3<this.gl[this.object.mode])&&!this.object.ns?1:0,this.ambientLight||.2,this.object.mix),this.gl.uniform4f(this.gl.getUniformLocation(this.program,"bb"),this.object.w,this.object.h,"billboard"==this.object.type,0),this.models[this.object.type].indicesBuffer&&this.gl.bindBuffer(34963,this.models[this.object.type].indicesBuffer),this.object.r?this.renderers[this.object.r](this.object):(this.gl.vertexAttrib4fv(this.gl.getAttribLocation(this.program,"col"),this.col(this.object.b)),this.models[this.object.type].indicesBuffer?this.gl.drawElements(+this.object.mode||this.gl[this.object.mode],this.models[this.object.type].indices.length,5123,0):this.gl.drawArrays(+this.object.mode||this.gl[this.object.mode],0,this.models[this.object.type].vertices.length/3)))}lerp(t,e){return this.next[t]?.a?this.current[t][e]+(this.next[t][e]-this.current[t][e])*(this.next[t].f/this.next[t].a):this.next[t][e]}animation(t,e=new DOMMatrix){return this.next[t]?e.translateSelf(this.lerp(t,"x"),this.lerp(t,"y"),this.lerp(t,"z")).rotateSelf(this.lerp(t,"rx"),this.lerp(t,"ry"),this.lerp(t,"rz")).scaleSelf(this.lerp(t,"w"),this.lerp(t,"h"),this.lerp(t,"d")):e}dist(t,e=this.next.camera){return t?.m&&e?.m?(e.m.m41-t.m.m41)**2+(e.m.m42-t.m.m42)**2+(e.m.m43-t.m.m43)**2:0}ambient(t){return this.ambientLight=t}col(t){return 5>(t=t.replace("#","")).length?[...[...t].map((t=>("0x"+t)/15)),1]:[...t.match(/../g).map((t=>("0x"+t)/255)),1]}add(t,e){this.models[t]=e,this[t]=e=>this.setState(e,t)}group(t){return this.setState(t,"group")}move(t,e){setTimeout((()=>{this.setState(t)}),e||1)}delete(t,e){setTimeout((()=>{delete this.next[t.n]}),e||1)}camera(t,e){setTimeout((()=>{this.setState(t,t.n="camera")}),e||1)}light(t,e){e?setTimeout((()=>{this.setState(t,t.n="light")}),e):this.setState(t,t.n="light")}}};export{t as default};
